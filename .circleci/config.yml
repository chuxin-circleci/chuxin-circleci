version: 2
jobs:
  info-job:
    docker:
      - image: huzhenghui/chuxin-generator-circleci:build-0.0.6
    steps:
      - run:
          name: Version Summary
          command: echo "Version - build-0.0.5"
      - run:
          name: Print the Current Time
          command: date
      - run:
          name: ls -al /chuxin-generator
          command: ls -al /chuxin-generator
  build-job:
    docker:
      - image: huzhenghui/chuxin-generator-circleci:build-0.0.6
    working_directory: /tmp/generated-docs
    steps:
      - run:
          name: cd /chuxin-generator && git submodule update --init
          command: cd /chuxin-generator && git submodule update --init
      - run:
          name: cd /chuxin-generator && git submodule update --remote
          command: cd /chuxin-generator && git submodule update --remote
      - run:
          name: cp --recursive --dereference --verbose /chuxin-generator/content-posts/* /chuxin-generator/gohugo-site/content/posts/
          command: cp --recursive --dereference --verbose /chuxin-generator/content-posts/* /chuxin-generator/gohugo-site/content/posts/
      - run:
          name: cd /chuxin-generator/gohugo-site && ln -s -f -T -v themes/huzhenghui-universal/exampleSite/data data
          command: cd /chuxin-generator/gohugo-site && ln -s -f -T -v themes/huzhenghui-universal/exampleSite/data data
      - run:
          name: cd /chuxin-generator/gohugo-site && ln -s -f -T -v themes/huzhenghui-universal/exampleSite/static static
          command: cd /chuxin-generator/gohugo-site && ln -s -f -T -v themes/huzhenghui-universal/exampleSite/static static
      - run:
          name: cd /chuxin-generator/gohugo-site && ./gohugo-generate.sh
          command: cd /chuxin-generator/gohugo-site && ./gohugo-generate.sh
      - run:
          name: cd /chuxin-generator/gohugo-site && ./gohugo-process-stdout.sh
          command: cd /chuxin-generator/gohugo-site && ./gohugo-process-stdout.sh
      - run:
          name: cd /chuxin-generator/gohugo-site && hugo -DEF
          command: cd /chuxin-generator/gohugo-site && hugo -DEF
      - run:
          name: cp --recursive --dereference --verbose /chuxin-generator/public-repository/docs/* /tmp/generated-docs/
          command: cp --recursive --dereference --verbose /chuxin-generator/public-repository/docs/* /tmp/generated-docs/
  deploy-job:
    docker:
      - image: huzhenghui/chuxin-generator-circleci:build-0.0.6
    working_directory: /tmp/generated-docs
    steps:
      - add_ssh_keys:
          fingerprints:
            - "f7:96:af:f1:35:c9:03:a0:b7:1e:64:34:e0:8f:4a:31"
      - run:
          name: ls -al /tmp/generated-docs/
          command: ls -al /tmp/generated-docs/
workflows:
  version: 2
  info-workflow:
    jobs:
      - info-job
      - build-job:
          requires:
            - info-job
          filters:
            branches:
              only: master
      - deploy-job:
          requires:
            - build-job
          filters:
            branches:
              only: master            
