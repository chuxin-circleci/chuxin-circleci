version: 2
jobs:
  build:
    docker:
      - image: huzhenghui/chuxin-generator-circleci:build-0.0.7
    steps:
      - run:
          name: Version Summary
          command: echo "Version - build-0.0.7"
      - run:
          name: Print the Current Time
          command: date
      - run:
          name: ls -al /chuxin-generator
          command: ls -al /chuxin-generator
  info-job:
    docker:
      - image: huzhenghui/chuxin-generator-circleci:build-0.0.7
    steps:
      - run:
          name: Version Summary
          command: echo "Version - build-0.0.7"
      - run:
          name: Print the Current Time
          command: date
      - run:
          name: ls -al /chuxin-generator
          command: ls -al /chuxin-generator
  build-job:
    docker:
      - image: huzhenghui/chuxin-generator-circleci:build-0.0.7
    steps:
      - run:
          name: cd /chuxin-generator && git pull
          command: cd /chuxin-generator && git pull
      - run:
          name: cd /chuxin-generator && git submodule update --init
          command: cd /chuxin-generator && git submodule update --init
      - run:
          name: cd /chuxin-generator && git submodule update --remote
          command: cd /chuxin-generator && git submodule update --remote
      - run:
          name: cp --recursive --dereference --verbose /chuxin-generator/content-posts/* /chuxin-generator/gohugo-site/content/posts/
          command: cp --recursive --dereference --verbose /chuxin-generator/content-posts/* /chuxin-generator/gohugo-site/content/posts/
      - run:
          name: cd /chuxin-generator/gohugo-site && ln -s -f -T -v themes/huzhenghui-universal/exampleSite/data data
          command: cd /chuxin-generator/gohugo-site && ln -s -f -T -v themes/huzhenghui-universal/exampleSite/data data
      - run:
          name: cd /chuxin-generator/gohugo-site && ln -s -f -T -v themes/huzhenghui-universal/exampleSite/static static
          command: cd /chuxin-generator/gohugo-site && ln -s -f -T -v themes/huzhenghui-universal/exampleSite/static static
      - run:
          name: cd /chuxin-generator/gohugo-site && ./gohugo-generate.sh
          command: cd /chuxin-generator/gohugo-site && ./gohugo-generate.sh
      - run:
          name: cd /chuxin-generator/gohugo-site && ./gohugo-process-stdout.sh
          command: cd /chuxin-generator/gohugo-site && ./gohugo-process-stdout.sh
      - run:
          name: cd /chuxin-generator/gohugo-site && hugo -DEF
          command: cd /chuxin-generator/gohugo-site && hugo -DEF
      - persist_to_workspace:
          root: /chuxin-generator/public-repository/
          paths: docs
  deploy-job:
    docker:
      - image: huzhenghui/chuxin-generator-circleci:build-0.0.7
    steps:
      - add_ssh_keys:
          fingerprints:
            - "f7:96:af:f1:35:c9:03:a0:b7:1e:64:34:e0:8f:4a:31"
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: ls -al /tmp/workspace/
          command: ls -al /tmp/workspace/
      - run:
          name: cd / && git clone git@github.com:chuxin-community/chuxin-community.github.io
          command: cd / && git clone git@github.com:chuxin-community/chuxin-community.github.io
      - run:
          name: cd /chuxin-community.github.io && cp --recursive --dereference --verbose /tmp/workspace/docs/* .
          command: cd /chuxin-community.github.io && cp --recursive --dereference --verbose /tmp/workspace/docs/* .
      - run:
          name: git config --global user.email "chuxin-community.github.com@daonao.com"
          command: git config --global user.email "chuxin-community.github.com@daonao.com"
      - run:
          name: git config --global user.name "chuxin-community"
          command: git config --global user.name "chuxin-community"
      - run:
          name: cd /chuxin-community.github.io && git add --verbose .
          command: cd /chuxin-community.github.io && git add --verbose .
      - run:
          name: cd /chuxin-community.github.io && git commit -m 'generatoed document'
          command: cd /chuxin-community.github.io && git commit -m 'generatoed document'
      - run:
          name: cd /chuxin-community.github.io && ls -al .
          command: cd /chuxin-community.github.io && ls -al .
      - run:
          name: cd /chuxin-community.github.io && git push
          command: cd /chuxin-community.github.io && git push
workflows:
  version: 2
  info-workflow:
    jobs:
      - info-job
      - build-job:
          requires:
            - info-job
          filters:
            branches:
              only: master
      - deploy-job:
          requires:
            - build-job
          filters:
            branches:
              only: master            
